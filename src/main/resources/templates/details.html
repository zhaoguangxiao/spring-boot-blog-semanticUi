<!DOCTYPE html>
<!--STATUS OK-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="main/_fragments :: header(~{::title},~{::link},~{::meta})">
    <!--  关键字  -->
    <meta type="keywords" content="博客详情页面"/>
    <!--  描述　-->
    <meta type="description" content="博客详情页面描述"/>
    <title th:text="${blogBean.title}"></title>
    <!--排版css-->
    <link rel="stylesheet" href="../static/css/typo.css" th:href="@{/static/css/typo.css}"/>
    <!--引入动画样式-->
    <link rel="stylesheet" href="../static/css/animate.css" th:href="@{/static/css/animate.css}">
    <!--引入代码高亮css-->
    <link rel="stylesheet" href="../static/css/prism.css" th:href="@{/static/css/prism.css}">
    <!--引入自动生成目录css-->
    <link rel="stylesheet" href="../static/css/tocbot.css" th:href="@{/static/css/tocbot.css}">
</head>
<body>

<!--头部导航-->
<div th:replace="main/_fragments :: menu(1)"></div>


<!--中间内容   ctrl+enter先输入内容然后注释-->
<!--div +tab 快速补全代码-->
<div id="middle-content" class="m-container-small m-padded-tb-big">
    <div class="ui container">
        <div class="ui top attached segment">
            <div class="ui header">
                <div class="ui grid">
                    <div class="eleven wide column">
                        <div class="ui horizontal link list">
                            <div class="item">
                                <img th:src="${blogBean.userBean.avatar}" alt="" class="ui avatar image">
                                <div class="content">
                                    <a href="#" th:href="@{/about}" class="header"
                                       th:text="${blogBean.userBean.nickName}"></a>
                                </div>
                            </div>
                            <div class="item">
                                <i class="calendar icon"></i>[[${#dates.format(blogBean.createTime,'yyyy-MM-dd
                                HH:mm:ss')}]]
                            </div>
                            <div class="item">
                                <i class="eye icon"></i>
                                <span class="views">[[${blogBean.views}]]</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--图片区域-->
            <div class="ui attached segment animated fadeIn">
                <img th:src="${blogBean.firstPicture}" alt="" class="image ui fluid rounded">
            </div>

            <!--内容-->
            <div class="ui attached padded segment">
                <div class="ui right aligned basic segment">
                    <div class="ui label basic orange">
                        原创
                    </div>
                </div>
                <h2 class="ui center aligned header animated heartBeat" th:text="${blogBean.title}"></h2>
                <br>
                <div id="content" class="js-toc-content typo typo-selection m-padded-left m-padded-tb-large">
                    <div th:utext="${blogBean.content}"></div>
                </div>
                <!--标签-->
                <div class="m-padded-left" th:each="each : ${blogBean.tagBeans}">
                    <div class="ui basic teal left pointing label" th:text="${each.name}"></div>
                </div>
                <!--赞赏功能-->
                <div class="ui center aligned basic segment">
                    <div id="payBtn" class="ui button circular orange basic">
                        赞赏
                    </div>
                    <br>
                    <div class="ui payButton flowing popup transition hidden">
                        <div class="ui orange basic label">
                            <div class="ui images" style="font-size: inherit;!important;">
                                <div class="image">
                                    <img src="../static/images/2017-07-10_59631d2325129.jpg" alt=""
                                         class="ui rounded bordered image" style="width: 120px">
                                    <div>支付宝</div>
                                </div>
                                <div class="image">
                                    <img src="../static/images/2017-07-10_59631d2325129.jpg" alt=""
                                         class="ui rounded bordered image" style="width: 120px">
                                    <div>微信</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!--博客信息-->
            <div class="ui attached positive message">
                <div class="ui middle aligned grid">
                    <div class="eleven wide column">
                        <ui class="list">
                            <li>作者:[[${blogBean.userBean.nickName}]]</li>
                            <li>发表时间:[[${#dates.format(blogBean.createTime,'yyyy-MM-dd HH:mm:ss')}]]</li>
                            <li>版权声明:自由转载-非商用-非衍生-保持署名</li>
                            <li>公众号转载:请在文章末尾添加作者公众号二维码</li>
                        </ui>
                    </div>
                    <div class="five wide column">
                        <img th:src="${blogBean.userBean.avatar}" alt=""
                             class="ui right floated rounded bordered image" style="width: 120px">
                    </div>
                </div>
            </div>


            <!--留言区域-->
            <div class="ui attached segment">
                <!--留言列表-->
                <div id="command-container" th:fragment="comment-list" class="ui teal comments">
                    <h3 class="ui dividing header">Comments</h3>
                    <div class="comment" th:each="each : ${commentBeans}">
                        <a class="avatar">
                            <img src="../static/images/box.png" th:src="@{${each.avatar}}">
                        </a>
                        <div class="content">
                            <a class="author" th:text="${each.nickName}"></a>
                            <div class="metadata">
                                <span class="date">[[${#dates.format(each.createTime,'yyyy-MM-dd HH:mm:ss')}]]</span>
                            </div>
                            <div class="text" th:text="${each.content}"></div>
                            <div class="actions">
                                <a class="reply" onclick="reply(this)"
                                   th:attr="data-comment-id=${each.id},data-comment-nickname=${each.nickName}">回复</a>
                            </div>
                        </div>
                        <div class="comments" th:if="${#arrays.length(each.replyComments)}>0">
                            <div class="comment" th:each="each : ${each.replyComments}">
                                <a class="avatar">
                                    <img th:src="@{${each.avatar}}">
                                </a>
                                <div class="content">
                                    <a class="author">
                                        [[${each.nickName}]]&nbsp;<span style="color: #00b5ad;!important;"
                                                                        th:text="|@ ${each.parentComment.nickName}|"></span>
                                    </a>
                                    <div class="metadata">
                                        <span class="date">[[${#dates.format(each.createTime,'yyyy-MM-dd HH:mm:ss')}]]</span>
                                    </div>
                                    <div class="text" th:text="${each.content}"></div>
                                    <div class="actions">
                                        <a class="reply" onclick="reply(this)"
                                           th:attr="data-comment-id=${each.id},data-comment-nickname=${each.nickName}">回复</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--留言表单-->
                <div id="comment-form" class="ui reply form">
                    <input type="hidden" name="blogBean.id" th:value="${blogBean.id}">

                    <input type="hidden" name="parentComment.id" value="-1">

                    <div class="field">
                        <textarea name="content" placeholder="请输入回复内容..."></textarea>
                    </div>
                    <div class="fields">
                        <div class="field m-mobile-width m-margin-top-small">
                            <div class="ui left icon input">
                                <i class="user icon"></i>
                                <input type="text" placeholder="姓名" name="nickName">
                            </div>
                        </div>
                        <div class="field m-mobile-width m-margin-top-small">
                            <div class="ui left icon input">
                                <i class="mail icon"></i>
                                <input type="text" placeholder="邮箱" name="email">
                            </div>
                        </div>
                        <div class="field m-mobile-width m-margin-top-small">
                            <button type="button" id="comment-btn-sub" class="ui teal m-mobile-width button">
                                <i class="edit icon"></i>
                                立即提交
                            </button>
                        </div>
                    </div>
                    <!--显示错误内容-->
                    <div class="field">
                        <div class="ui error message"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="toolbar-list" class="m-padded-tb-max m-fixed m-right-button" style="display: none;">
    <div class="ui vertical icon buttons">
        <button id="catalog" class="ui teal button" type="button">目录</button>
        <a href="#command-container" class="ui teal button">留言</a>
        <button class="ui button click-wechat"><i class="weixin icon"></i></button>
        <div id="toTop-div" class="ui button">
            <i class="chevron up icon"></i>
        </div>
    </div>
</div>


<!--目录内容-->
<div class="ui catalog-click flowing popup transition hidden" style=" width: 250px;!important;">
    <ol class="js-toc">
    </ol>
</div>
<!--微信二维码-->
<div id="qrcode" class="ui share-wechat flowing popup transition hidden m-padded-mini" style="width: 130px!important;">
    <!--<img src="static/images/2017-07-10_59631d2325129.jpg" alt=""  class="ui rounded image">-->
</div>


<!--尾部-->
<div th:replace="main/_fragments :: footer"></div>


<!--引入js-->
<th:block th:replace="main/_fragments :: script"></th:block>

<!--引入代码高亮js-->
<script src="../static/js/prism.js" th:src="@{/static/js/prism.js}"></script>
<!--引入自动生成目录js-->
<script src="../static/js/tocbot.min.js" th:src="@{/static/js/tocbot.min.js}"></script>
<!--引入生成二维码js-->
<script src="../static/js/qrcode.min.js" th:src="@{/static/js/qrcode.min.js}"></script>
<!--平滑滚动js-->
<script src="../static/js/jquery.scrollTo.min.js" th:src="@{/static/js/jquery.scrollTo.min.js}"></script>
<!--滚动监听 js-->
<script src="../static/js/jquery.waypoints.min.js" th:src="@{/static/js/jquery.waypoints.min.js}"></script>
<!--cookiejs-->
<script type="text/javascript" th:src="@{/static/js/jquery.cookie.js}"></script>

<script language='javascript' th:inline="javascript">

    // 初始化目录
    tocbot.init({
        // 初始目录到那个区域
        tocSelector: '.js-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.js-toc-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });


    $('#payBtn').popup({
        popup: $('.payButton.popup'),
        on: 'click',
        position: 'bottom center'
    });


    // 点击目录事件
    $('#catalog').popup({
        popup: $('.catalog-click.popup'),
        on: 'click',
        position: 'left center'
    });

    // 目录微信二维码
    $('.click-wechat').popup({
        popup: $('.share-wechat'),
        on: 'click',
        position: 'left center'
    });


    //生成二维码
    var qrcode = new QRCode("qrcode", {
        text: "http://jindo.dev.naver.com/collie",
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });


    // 返回顶部方法
    $('#toTop-div').click(function () {
        $(window).scrollTo(0, 500);
    });


    // 滚动监听js事件
    var waypoint = new Waypoint({
        element: document.getElementById('middle-content'),
        handler: function (direction) {
            if (direction == 'down') {
                $('#toolbar-list').show(100);
            } else {
                $('#toolbar-list').hide(500);
            }
        }
    });

    // 表单验证
    $('.ui.form')
        .form({
            fields: {
                nickName: {
                    identifier: 'nickName',
                    rules: [
                        {
                            type: 'empty',
                            prompt: '评论昵称不能为空'
                        }
                    ]
                },
                email: {
                    identifier: 'email',
                    rules: [
                        {
                            type: 'empty',
                            prompt: '邮箱不能为空'
                        }
                    ]
                },
                content: {
                    identifier: 'content',
                    rules: [
                        {
                            type: 'empty',
                            prompt: '回复内容不能为空'
                        }
                    ]
                }
            },
        });

    //留言提交事件
    $("#comment-btn-sub").click(function () {
        //效验表单
        var hasBoo = $('.ui.form').form('validate form');
        if (hasBoo) {
            postData();
        }
    });


    //发送请求的方法
    function postData() {
        $("#command-container").load("/comments", {
            "parentComment.id": $("[name='parentComment.id']").val(),
            "blogBean.id": $("[name='blogBean.id']").val(),
            "content": $("[name='content']").val(),
            "nickName": $("[name='nickName']").val(),
            "email": $("[name='email']").val()
        }, function (responseTxt, statusTxt, xhr) {
            clearMessage();
        });
    }


    //清空context内容
    function clearMessage() {
        $("[name='content']").val('');
        $("[name='parentComment.id']").val(-1);
        $("[name='content']").attr("placeholder", "请输入评论信息...");
    }

    //回复点击事件处理
    function reply(obj) {
        var commentId = $(obj).data('comment-id');
        var nickName = $(obj).data('comment-nickname');
        console.log(nickName);

        //设置回复内容
        $("[name='content']").attr("placeholder", "@" + nickName).focus();
        $("[name='parentComment.id']").val(commentId);
        $(window).scrollTo($("#comment-form"), 500);
    }

    increaseViewCount();

    //浏览量ajax+cookie
    function increaseViewCount() {
        if ($.cookie("viewId") != [[${blogBean.id}]]) {
            $.ajax({
                async: false,
                type: "POST",
                url: "/addView",
                data: {id: [[${blogBean.id}]]},
                dataType: "json",
                success: function (response) {
                    $(".views").html(response);
                    $.cookie(
                        "viewId",
                        [[${blogBean.id}]],//需要cookie写入的业务
                        {
                            "path": "/", //cookie的默认属性
                        }
                    );
                },
                error: function () {
                    alert("获取数据出错!");
                },
            });
        }
    }


</script>
</body>
</html>